# https://taskfile.dev

version: 3

tasks:
  build-git:
    desc: "Build from source."
    env:
      GNOCI_BUILD_PATH: bin/git-remote-oci
    cmds:
      - dagger call build-git export --path {{ .GNOCI_GIT_BUILD_PATH }}

  build-git-lfs:
    desc: "Build from source."
    env:
      GNOCI_BUILD_PATH: bin/git-lfs-remote-oci
    cmds:
      - dagger call build-git-lfs export --path {{ .GNOCI_GIT_LFS_BUILD_PATH }}

  coverage:
    desc: "Generage code coverage treemap, a visual aid."
    env:
      OUTPUT: coverage-treemap.svg
    cmds:
      - dagger -c 'test | coverage-tree-map -- $(test | coverage) | export -- coverage-treemap.svg'

  coverage-docs:
    desc: "Generate code coverage badge and treemap for README.md docs."
    cmds:
      - |
        dagger -c 'test | coverage | export -- docs/figures/badges/coverage.out'
        dagger -c 'test | coverage-tree-map -- docs/figures/badges/coverage.out | export -- docs/figures/badges/coverage-treemap.svg'

        COVERAGE=$(go tool cover -func=docs/figures/badges/coverage.out | grep total | awk '{print $3}' | sed 's/%//')

        rm docs/figures/badges/coverage.svg
        anybadge --label=coverage --value=$COVERAGE \
          --file=docs/figures/badges/coverage.svg \
          50=red 80=yellow 100=green
  
  go-generate:
    desc: "Run go generate."
    sources:
      - "*.go"
      - "**/*.go"
    cmds:
      - go generate ./...
